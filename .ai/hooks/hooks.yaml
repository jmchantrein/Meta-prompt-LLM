# Hooks Source of Truth
# ============================================================================
# Source de vÃ©ritÃ© pour tous les hooks du projet Meta-prompt-LLM.
#
# FLUX DE DONNÃ‰ES:
#   1. Ce fichier (data/hooks/hooks.yaml) = Source de vÃ©ritÃ©
#   2. data-sync copie vers .ai/hooks/hooks.yaml
#   3. generate.sh gÃ©nÃ¨re .claude/settings.json
#
# LIFECYCLE EVENTS (ordre d'exÃ©cution):
#   1. SessionStart     - Avant toute interaction utilisateurÂ·ice
#   2. UserPromptSubmit - Quand l'utilisateurÂ·ice envoie un message
#   3. PreToolUse       - Avant l'exÃ©cution d'un outil (peut bloquer)
#   4. PostToolUse      - AprÃ¨s l'exÃ©cution d'un outil
#   5. Stop             - Quand Claude finit de rÃ©pondre
#   6. SessionEnd       - Quand la session se termine
#
# HOOK TYPES:
#   - command: ExÃ©cute une commande shell (exit 0 = succÃ¨s)
#   - prompt:  Question oui/non Ã  l'utilisateurÂ·ice
#   - agent:   Sous-agent avec accÃ¨s aux outils (Read, Grep, Glob)
#
# VISUAL FEEDBACK CONVENTION:
#   Les hooks utilisent des prÃ©fixes emoji pour indiquer l'agent actif:
#   ğŸ”§ [data-sync] - Agent de synchronisation
#   ğŸ§  [memory-keeper] - Agent mÃ©moire
#   ğŸ”„ [self-improver] - Agent d'amÃ©lioration
#   âœ… [consistency-check] - VÃ©rification de consistance
#   ğŸ“Š [workflow-orchestrator] - Orchestrateur
#
# ============================================================================

version: "2.0.0"
updated: "2026-02-02"

# ============================================================================
# SESSION START - Initialisation AVANT toute interaction
# ============================================================================
# Runs when a session begins. source = "startup" | "resume" | "clear" | "compact"
# Output goes to additionalContext for Claude to see.

SessionStart:
  # ----------------------------
  # 1. Data sync check
  # ----------------------------
  - name: "init-data-sync"
    description: "Synchronize data/ to .ai/ at session start"
    enabled: true
    matcher: "startup"  # Only on new sessions
    hooks:
      - type: "command"
        timeout: 30
        command: |
          echo "ğŸ”§ [data-sync] VÃ©rification de synchronisation..."

          DATA_DIR="prompts/fr/metametaprompts/data"
          AI_DIR=".ai"

          # Check if data/ has changes not in .ai/
          if [ -d "$DATA_DIR/skills" ] && [ -d "$AI_DIR/skills" ]; then
            DATA_HASH=$(find "$DATA_DIR/skills" -name "*.yaml" -exec cat {} \; 2>/dev/null | md5sum | cut -d' ' -f1)
            AI_HASH=$(find "$AI_DIR/skills" -name "*.yaml" -exec cat {} \; 2>/dev/null | md5sum | cut -d' ' -f1)

            if [ "$DATA_HASH" != "$AI_HASH" ]; then
              echo "âš ï¸ [data-sync] Changements dÃ©tectÃ©s dans data/, synchronisation nÃ©cessaire"
              echo "   ExÃ©cutez: cp -r $DATA_DIR/skills/* $AI_DIR/skills/"
            else
              echo "âœ… [data-sync] Skills synchronisÃ©s"
            fi
          fi

          # Check hooks sync
          if [ -f "$DATA_DIR/hooks/hooks.yaml" ] && [ -f "$AI_DIR/hooks/hooks.yaml" ]; then
            DATA_HOOKS_HASH=$(md5sum "$DATA_DIR/hooks/hooks.yaml" | cut -d' ' -f1)
            AI_HOOKS_HASH=$(md5sum "$AI_DIR/hooks/hooks.yaml" | cut -d' ' -f1)

            if [ "$DATA_HOOKS_HASH" != "$AI_HOOKS_HASH" ]; then
              echo "âš ï¸ [data-sync] hooks.yaml dÃ©synchronisÃ©, copie..."
              cp "$DATA_DIR/hooks/hooks.yaml" "$AI_DIR/hooks/hooks.yaml"
              echo "âœ… [data-sync] hooks.yaml synchronisÃ©"
            fi
          fi

  # ----------------------------
  # 2. Generate check
  # ----------------------------
  - name: "init-generate-check"
    description: "Check if generate.sh needs to run"
    enabled: true
    matcher: "startup|resume"
    hooks:
      - type: "command"
        timeout: 60
        command: |
          echo "ğŸ”§ [generate] VÃ©rification des fichiers gÃ©nÃ©rÃ©s..."

          if [ -f ".ai/generate.sh" ]; then
            if ! .ai/generate.sh --check 2>/dev/null; then
              echo "âš ï¸ [generate] RÃ©gÃ©nÃ©ration nÃ©cessaire..."
              .ai/generate.sh 2>/dev/null && echo "âœ… [generate] Fichiers rÃ©gÃ©nÃ©rÃ©s" || echo "âŒ [generate] Ã‰chec"
            else
              echo "âœ… [generate] Fichiers Ã  jour"
            fi
          fi

  # ----------------------------
  # 3. Load memory context
  # ----------------------------
  - name: "init-load-memory"
    description: "Load project memory into context"
    enabled: true
    hooks:
      - type: "command"
        command: |
          echo "ğŸ§  [memory-keeper] Chargement du contexte..."

          if [ -f ".ai/MEMORY.md" ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "                    CONTEXTE PROJET CHARGÃ‰"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cat ".ai/MEMORY.md"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          else
            echo "âš ï¸ [memory-keeper] Fichier .ai/MEMORY.md non trouvÃ©"
          fi

  # ----------------------------
  # 4. Self-improver quick check
  # ----------------------------
  - name: "init-self-improver"
    description: "Quick check for rule/skill changes"
    enabled: true
    matcher: "startup"
    hooks:
      - type: "command"
        timeout: 10
        command: |
          echo "ğŸ”„ [self-improver] VÃ©rification des changements de rÃ¨gles..."

          # Check AGENTS.md hash vs stored hash
          if [ -f "AGENTS.md" ] && [ -f ".ai/VERSION" ]; then
            CURRENT_HASH=$(md5sum AGENTS.md | cut -d' ' -f1)
            STORED_INFO=$(cat .ai/VERSION)

            # Simple check - if AGENTS.md changed since last generate
            if ! echo "$STORED_INFO" | grep -q "agents"; then
              echo "â„¹ï¸ [self-improver] PremiÃ¨re session ou version mise Ã  jour"
            fi
          fi

          echo "âœ… [self-improver] VÃ©rification terminÃ©e"

# ============================================================================
# USER PROMPT SUBMIT - Ã€ chaque message utilisateurÂ·ice
# ============================================================================

UserPromptSubmit:
  - name: "user-context-reminder"
    description: "Rappel lÃ©ger du contexte"
    enabled: true
    hooks:
      - type: "command"
        command: |
          # Feedback visuel discret
          echo "ğŸ“‹ Session active | MÃ©moire: .ai/MEMORY.md"

# ============================================================================
# PRE TOOL USE - Avant l'exÃ©cution d'un outil
# ============================================================================

PreToolUse:
  # ----------------------------
  # Guardrails - Fichiers sensibles
  # ----------------------------
  - name: "protect-env-files"
    description: "Require confirmation before writing to .env files"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          if echo "$FILE_PATH" | grep -qE '\.env'; then
            echo '{"hookSpecificOutput":{"hookEventName":"PreToolUse","permissionDecision":"ask","permissionDecisionReason":"âš ï¸ Ã‰criture dans un fichier .env dÃ©tectÃ©e. Contient potentiellement des secrets."}}'
            exit 0
          fi
          exit 0

  - name: "protect-credentials"
    description: "Block writes to credential files"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          if echo "$FILE_PATH" | grep -qiE 'credential|secret|password|token|key\.'; then
            echo '{"hookSpecificOutput":{"hookEventName":"PreToolUse","permissionDecision":"ask","permissionDecisionReason":"âš ï¸ Ã‰criture dans un fichier de credentials dÃ©tectÃ©e."}}'
            exit 0
          fi
          exit 0

  # ----------------------------
  # Guardrails - OpÃ©rations destructives
  # ----------------------------
  - name: "protect-destructive-git"
    description: "Protect against destructive git operations"
    enabled: true
    matcher: "Bash"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          COMMAND=$(echo "$INPUT" | grep -o '"command"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"command"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          # Check for dangerous patterns
          if echo "$COMMAND" | grep -qE 'git (push.*--force|reset --hard|clean -[fd])'; then
            echo '{"hookSpecificOutput":{"hookEventName":"PreToolUse","permissionDecision":"ask","permissionDecisionReason":"âš ï¸ OpÃ©ration git destructive dÃ©tectÃ©e. Confirmer?"}}'
            exit 0
          fi

          if echo "$COMMAND" | grep -qE 'rm -rf'; then
            echo '{"hookSpecificOutput":{"hookEventName":"PreToolUse","permissionDecision":"ask","permissionDecisionReason":"âš ï¸ Suppression rÃ©cursive dÃ©tectÃ©e. Confirmer?"}}'
            exit 0
          fi
          exit 0

  # ----------------------------
  # Guardrails - Protection source de vÃ©ritÃ©
  # ----------------------------
  - name: "protect-generated-files"
    description: "Warn when editing generated files instead of source"
    enabled: true
    matcher: "Write|Edit"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          # Check if editing .ai/ directly (should edit data/ instead)
          if echo "$FILE_PATH" | grep -qE '^\.ai/(skills|hooks)/'; then
            echo '{"hookSpecificOutput":{"hookEventName":"PreToolUse","permissionDecision":"ask","permissionDecisionReason":"âš ï¸ Modification directe de .ai/ dÃ©tectÃ©e. PrÃ©fÃ©rez modifier data/ (source de vÃ©ritÃ©)."}}'
            exit 0
          fi
          exit 0

# ============================================================================
# POST TOOL USE - AprÃ¨s l'exÃ©cution d'un outil
# ============================================================================

PostToolUse:
  # ----------------------------
  # Auto-regenerate on skill changes
  # ----------------------------
  - name: "auto-generate-on-skill-change"
    description: "Regenerate platform configs when skills are modified"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          if echo "$FILE_PATH" | grep -qE '(data/skills|\.ai/skills)/.*\.yaml$'; then
            echo "ğŸ“¦ [generate] Skill modifiÃ©, rÃ©gÃ©nÃ©ration..."
            .ai/generate.sh 2>/dev/null && echo "âœ… [generate] RÃ©gÃ©nÃ©rÃ©" || echo "âŒ [generate] Ã‰chec"
          fi

  # ----------------------------
  # Sync data to .ai on data changes
  # ----------------------------
  - name: "auto-sync-on-data-change"
    description: "Sync data/ to .ai/ when data files change"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          # If data/hooks changed, sync to .ai/hooks
          if echo "$FILE_PATH" | grep -qE 'data/hooks/.*\.yaml$'; then
            echo "ğŸ”§ [data-sync] Hooks modifiÃ©s, synchronisation..."
            cp "prompts/fr/metametaprompts/data/hooks/hooks.yaml" ".ai/hooks/hooks.yaml" 2>/dev/null
            echo "âœ… [data-sync] Hooks synchronisÃ©s vers .ai/"
          fi

          # If data/skills changed, sync to .ai/skills
          if echo "$FILE_PATH" | grep -qE 'data/skills/.*\.yaml$'; then
            SKILL_NAME=$(basename "$FILE_PATH")
            echo "ğŸ”§ [data-sync] Skill modifiÃ©: $SKILL_NAME"
            cp "$FILE_PATH" ".ai/skills/$SKILL_NAME" 2>/dev/null
            echo "âœ… [data-sync] Skill synchronisÃ© vers .ai/"
          fi

  # ----------------------------
  # Inclusive writing reminder
  # ----------------------------
  - name: "inclusivity-reminder-fr"
    description: "Remind about inclusive writing for French files"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

          if echo "$FILE_PATH" | grep -qE '/fr/.*\.md$'; then
            echo "ğŸ” [inclusivity] Contenu FR modifiÃ©. Rappel: Ã©criture inclusive requise."
          fi

  # ----------------------------
  # Translation sync reminder
  # ----------------------------
  - name: "translation-sync-reminder"
    description: "Remind to sync translations when docs change"
    enabled: true
    matcher: "Write"
    hooks:
      - type: "command"
        command: |
          INPUT=$(cat)
          FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"[^"]*\)".*/\1/')

          if echo "$FILE_PATH" | grep -qE 'docs/en/.*\.md$'; then
            FR_PATH=$(echo "$FILE_PATH" | sed 's|docs/en/|docs/fr/|')
            echo "ğŸŒ [translator] Doc EN modifiÃ©. VÃ©rifier traduction FR: $FR_PATH"
          fi

# ============================================================================
# STOP - Quand Claude finit de rÃ©pondre
# ============================================================================
# Ce hook vÃ©rifie si des actions de consistance sont nÃ©cessaires.
# Si oui, il retourne { "ok": false, "reason": "..." } pour continuer.

Stop:
  - name: "consistency-check"
    description: "Check if memory or consistency actions are needed"
    enabled: true
    hooks:
      - type: "agent"
        timeout: 60
        prompt: |
          Tu es l'agent de vÃ©rification de consistance du projet Meta-prompt-LLM.

          ## Contexte

          Tu es appelÃ© Ã  la fin de chaque rÃ©ponse de Claude pour vÃ©rifier
          si des actions de consistance sont nÃ©cessaires.

          ## Ta mission

          1. Lis le transcript de la session via $ARGUMENTS
          2. DÃ©termine si cette session a impliquÃ©:
             - Des dÃ©cisions techniques importantes
             - Des modifications de rÃ¨gles ou skills
             - Des leÃ§ons apprises
             - Des changements de contexte projet

          3. Si OUI Ã  l'un de ces points:
             - Retourne { "ok": false, "reason": "ğŸ§  [memory-keeper] Mise Ã  jour de .ai/MEMORY.md recommandÃ©e: [rÃ©sumÃ© des changements]" }

          4. Si NON (conversation simple, pas de dÃ©cision):
             - Retourne { "ok": true }

          ## CritÃ¨res de dÃ©cision

          METTRE Ã€ JOUR MEMORY.MD si:
          - Nouvelle dÃ©cision technique prise
          - Nouveau skill crÃ©Ã© ou modifiÃ©
          - Nouvelle rÃ¨gle ou convention adoptÃ©e
          - ProblÃ¨me rÃ©solu qui constitue une leÃ§on
          - Changement de contexte projet

          NE PAS METTRE Ã€ JOUR si:
          - Simple question/rÃ©ponse
          - Lecture de fichiers sans modification
          - ExÃ©cution de commandes routiniÃ¨res
          - Correction de typos mineurs

          ## Format de rÃ©ponse

          Retourne UNIQUEMENT un objet JSON:
          { "ok": true }
          ou
          { "ok": false, "reason": "ğŸ§  [memory-keeper] [description de ce qui doit Ãªtre ajoutÃ© Ã  MEMORY.md]" }

# ============================================================================
# SESSION END - Quand la session se termine
# ============================================================================

SessionEnd:
  - name: "final-memory-reminder"
    description: "Final reminder to update memory"
    enabled: true
    hooks:
      - type: "command"
        command: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    FIN DE SESSION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Si des dÃ©cisions importantes ont Ã©tÃ© prises,"
          echo "   assurez-vous que .ai/MEMORY.md est Ã  jour."
          echo ""
          echo "ğŸ”„ Pour la prochaine session:"
          echo "   - SessionStart chargera automatiquement le contexte"
          echo "   - data-sync vÃ©rifiera la synchronisation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ============================================================================
# VISUAL FEEDBACK REFERENCE
# ============================================================================
#
# Cette section documente les conventions de feedback visuel utilisÃ©es.
#
# STRUCTURE D'UN MESSAGE DE FEEDBACK:
#   [emoji] [agent] [action] [dÃ©tails]
#
# EMOJIS PAR CATÃ‰GORIE:
#   âœ… SuccÃ¨s
#   âš ï¸ Attention requise
#   âŒ Ã‰chec
#   ğŸ“‹ Information
#   ğŸ”§ Maintenance/sync
#   ğŸ§  MÃ©moire
#   ğŸ”„ Auto-amÃ©lioration
#   ğŸ“¦ GÃ©nÃ©ration
#   ğŸ” VÃ©rification
#   ğŸŒ Traduction
#   ğŸ“Š Orchestration
#
# AGENTS IDENTIFIÃ‰S:
#   [data-sync]          - Synchronisation data/ â†’ .ai/
#   [generate]           - GÃ©nÃ©ration de fichiers
#   [memory-keeper]      - Gestion mÃ©moire
#   [self-improver]      - Auto-amÃ©lioration
#   [consistency-check]  - VÃ©rification post-rÃ©ponse
#   [inclusivity]        - Ã‰criture inclusive
#   [translator]         - Synchronisation EN/FR
#
# IMBRICATION (THREAD LEVEL):
#   Niveau 0: Agent principal (Claude)
#   Niveau 1: â””â”€â”€ Sous-agent (invoquÃ© par Claude)
#   Niveau 2:     â””â”€â”€ Sous-sous-agent (invoquÃ© par sous-agent)
#
# Exemple de sortie:
#   ğŸ”§ [data-sync] VÃ©rification de synchronisation...
#   â”œâ”€â”€ Checking skills: data/skills/*.yaml
#   â”œâ”€â”€ Checking hooks: data/hooks/hooks.yaml
#   â””â”€â”€ âœ… Synchronisation complÃ¨te
#
# ============================================================================
