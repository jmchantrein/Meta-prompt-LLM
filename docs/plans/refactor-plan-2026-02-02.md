# Refactoring Plan: Meta-prompt-LLM

**Date**: 2026-02-02
**Based on**: Codebase Analysis Report (same date)
**Status**: âœ… PHASE 1 & 2 COMPLETED (via yq simplification)

---

## Executive Summary

This plan addresses 6 identified issues from the codebase analysis, organized into 3 phases with clear deliverables and estimated effort.

**Total estimated effort**: ~~40-60 hours~~ â†’ 8-12 hours (simplified with yq)
**Recommended approach**: Incremental, one phase at a time

### Progress Summary

| Phase | Status | Notes |
|-------|--------|-------|
| Phase 1 | âœ… DONE | yq replaced regex YAML parsing (-270 lines) |
| Phase 2 | âœ… DONE | Hook state machine replaced with yq (~50 lines) |
| Phase 3 | ğŸ”„ IN PROGRESS | Documentation updated |

---

## Phase 1: Foundation Improvements (Priority: HIGH) âœ… COMPLETED

**Goal**: Stabilize core infrastructure and reduce technical debt

### 1.1 Extract YAML Parsing Module âœ… DONE

**Issue**: `generate.sh:160-225` - Fragile regex-based YAML parsing

**Solution implemented**: Direct yq usage (no fallback needed - yq is a basic tool)

```bash
# Simplified with yq (15 lines instead of 70)
yaml_get() {
    local file="$1"
    local key="$2"
    yq -r ".${key} // empty" "${file}" 2>/dev/null
}
yaml_get_block() {
    local file="$1"
    local key="$2"
    yq -r ".${key} // empty" "${file}" 2>/dev/null
}
yaml_get_list() {
    local file="$1"
    local key="$2"
    yq -r ".${key}[]? // empty" "${file}" 2>/dev/null
}
```

**Outcome**:
- [x] `.ai/generate.sh` - YAML functions simplified with yq
- [x] No `.ai/lib/` needed (KISS principle)
- [x] yq documented as requirement

**Actual effort**: ~1 hour
**Lines removed**: 55 lines

---

### 1.2 Implement Manifest Validation â³ DEFERRED

**Issue**: `data/manifest.yaml` integrity hashes unused

**Status**: Low priority - hashes exist for future CI integration

**Rationale for deferral**:
- Manual workflow doesn't require automatic validation
- Can be added when CI/CD pipeline is implemented
- Current data-sync skill handles integrity manually

**Estimated effort**: 2-3 hours (when needed)
**Risk**: Low

---

## Phase 2: Hook System Refactoring (Priority: HIGH) âœ… COMPLETED

### 2.1 Extract Hook Generation State Machine âœ… DONE (SIMPLIFIED)

**Issue**: `generate.sh:1089-1310` - 222-line state machine with 13+ variables

**Solution implemented**: Replaced entire state machine with single yq command

```bash
# ~50 lines instead of 266 - direct YAMLâ†’JSON transformation
generate_claude_hooks() {
    yq '
      def transform_hook:
        select(.enabled == true) |
        del(.name, .description, .enabled);
      {
        "_comment": "Auto-generated by generate.sh",
        "hooks": {
          "SessionStart": [.SessionStart[]? | transform_hook],
          "UserPromptSubmit": [.UserPromptSubmit[]? | transform_hook],
          "PreToolUse": [.PreToolUse[]? | transform_hook],
          "PostToolUse": [.PostToolUse[]? | transform_hook],
          "Stop": [.Stop[]? | transform_hook]
        }
      }
      | .hooks |= with_entries(select(.value | length > 0))
    ' "${HOOKS_FILE}" > "${CLAUDE_SETTINGS}"
}
```

**Outcome**:
- [x] No `.ai/lib/` directory needed (KISS)
- [x] No separate parser/transformer modules
- [x] State machine eliminated entirely
- [x] 216 lines removed

**Actual effort**: ~2 hours
**Lines removed**: 216 lines

---

### 2.2 Create Platform Capability Mapping â³ DEFERRED

**Issue**: Inconsistent feature support across platforms

**Status**: Already documented in MEMORY.md (Platform Support Matrix)

**Current documentation** (from MEMORY.md):
| Platform | Rating | Limitations |
|----------|--------|-------------|
| Claude Code | â˜…â˜…â˜…â˜…â˜… | None - all 6 events + agent hooks |
| Cursor | â˜…â˜…â˜…â˜…â˜† | No SessionStart, no agent hooks |
| OpenCode | â˜…â˜…â˜…â˜†â˜† | Requires oh-my-opencode plugin |
| Codex CLI | â˜…â˜…â˜†â˜†â˜† | Only notify on agent-turn-complete |
| Aider | â˜…â˜†â˜†â˜†â˜† | No hooks, only auto_lint/test_cmd |
| Continue.dev | â˜…â˜†â˜†â˜†â˜† | Data events only, no command hooks |

**Rationale for deferral**:
- MEMORY.md already contains platform matrix
- No separate `.ai/data/` file needed (source of truth is `data/`)
- Can add programmatic mapping when needed for automation

**Estimated effort**: 2-3 hours (when needed)
**Risk**: Low

---

## Phase 3: Documentation & Quality (Priority: MEDIUM) ğŸ”„ IN PROGRESS

### 3.1 Bilingual Documentation Sync Check â³ DEFERRED

**Issue**: No automated detection of translation drift

**Status**: Low priority - translator skill handles this manually

**Rationale for deferral**:
- Current workflow is manual (AI-assisted)
- translator skill already tracks sync status
- Can add automation when CI/CD is implemented

**Estimated effort**: 3-4 hours (when needed)
**Risk**: Low

---

### 3.2 Add State Machine Documentation âœ… OBSOLETE (replaced by yq)

**Issue**: Hook parsing logic undocumented

**Resolution**: State machine no longer exists - replaced by yq transformation

**Documentation updated**:
- [x] `docs/en/architecture.md` - Added yq documentation section
- [x] `docs/fr/architecture.md` - French translation updated
- [x] Removed obsolete references to `.ai/lib/` directories

**Actual effort**: ~30 minutes

---

## Implementation Order (REVISED)

```
âœ… Session 1 (2026-02-02): yq Simplification
â”œâ”€â”€ âœ… 1.1 YAML Parsing â†’ yq
â”œâ”€â”€ âœ… 2.1 Hook State Machine â†’ yq
â””â”€â”€ âœ… 3.2 Documentation updated

ğŸ”„ Session 2 (current): Continued Simplification
â”œâ”€â”€ ğŸ”„ 3.2 Documentation cleanup (EN/FR architecture.md)
â”œâ”€â”€ â³ Simplify generate_claude_commands() with yq
â””â”€â”€ â³ Factorize duplicate skill loops (10 occurrences)

â³ Future (when needed):
â”œâ”€â”€ 1.2 Manifest validation (CI/CD integration)
â”œâ”€â”€ 2.2 Platform capabilities (automation)
â””â”€â”€ 3.1 Docs sync check (CI/CD)
```

---

## Success Criteria

### Phase 1 âœ… DONE
- [x] `yq` used (no fallback - it's a basic tool)
- [ ] ~~Manifest validation~~ (deferred)
- [x] No regressions in existing generation

### Phase 2 âœ… DONE
- [x] ~~Hook parsing in separate module~~ â†’ Eliminated with yq
- [x] ~~Each platform has dedicated writer~~ â†’ Single yq command
- [ ] ~~Capabilities documented in YAML~~ â†’ Already in MEMORY.md

### Phase 3 ğŸ”„ IN PROGRESS
- [ ] ~~`--check-docs` flag~~ (deferred)
- [x] ~~State machine fully documented~~ â†’ Replaced with yq docs
- [ ] ~~All tests pass~~ (no tests exist yet)

---

## Risks & Mitigations (Updated)

| Risk | Probability | Impact | Mitigation | Status |
|------|-------------|--------|------------|--------|
| Hook parsing regression | ~~Medium~~ Low | High | yq handles edge cases | âœ… Mitigated |
| YAML parser edge cases | Low | Low | yq is robust | âœ… Mitigated |
| yq dependency | Low | Low | Basic tool, easy to install | âœ… Accepted |

---

## Rollback Plan

Each phase is independently deployable. If issues arise:
1. Revert commits for that phase
2. Previous functionality remains intact
3. Document what failed for future attempt

**Note**: yq-based implementation is simpler and more maintainable than original regex-based approach.

---

## Remaining Work

### Immediate (this session)
1. â³ Simplify `generate_claude_commands()` with yq (~90 lines â†’ ~20 lines)
2. â³ Factorize 10 duplicate `for skill_file in $(get_skill_files)` loops

### Future (when needed)
- Manifest validation (CI/CD)
- Platform capabilities mapping (automation)
- Docs sync check (CI/CD)

---

## Results Summary

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| generate.sh lines | 1747 | 1477 | -270 (-15.5%) |
| YAML parsing | 70 lines | 15 lines | -55 (-78.6%) |
| Hook generation | 266 lines | 50 lines | -216 (-81.2%) |
| State variables | 13+ | 0 | Eliminated |
| External modules | 3 planned | 0 | KISS principle |

---

*Updated: 2026-02-03*
*Original: codebase-analyst + prompt-engineer skills*
*Refactoring: yq simplification (session VAj2K)*
